import{d as me,u as pe,r as D,s as S,k as x,p as ce,c as V,a as d,b as t,q as z,t as _,w as o,e as n,E as v,V as fe,i as m,C as ge,W as _e,x as be,y as ve,z as ye,l as w,F as q,m as G,f as Ie,o as p,_ as De}from"./index-jbbSaPHq.js";import{g as we,u as Te,c as Ce,d as Ve}from"./training-Cgu9WEGG.js";import{g as he}from"./contest-Cg3IoMP6.js";const ke={class:"training-plan-page page-shell"},Ee={class:"page-header"},Se={class:"page-header__title"},xe={class:"page-header__subtitle"},ze={key:0,class:"header-actions"},Ne={class:"plan-title-cell"},Ue={class:"plan-title"},Le={class:"time-range"},He={class:"table-footer"},Pe=me({__name:"list",setup(Re){const O=Ie(),N=pe(),U=D([]),h=D(!1),c=S({keyword:"",status:""}),r=S({page:1,pageSize:10,total:0}),F=x(()=>N.role==="ADMIN"),A=x(()=>N.role==="TEACHER"),y=x(()=>F.value||A.value),a=S({visible:!1,title:"新建训练计划",isEdit:!1,submitting:!1,form:{planId:void 0,title:"",description:"",startTime:"",endTime:"",contestIds:[],studentIds:[]}}),T=D(),L=D([]),H=D([]),B={title:[{required:!0,message:"请输入计划名称",trigger:"blur"},{min:2,max:100,message:"长度在 2 到 100 个字符",trigger:"blur"}],startTime:[{required:!0,message:"请选择开始时间",trigger:"change"}],endTime:[{required:!0,message:"请选择结束时间",trigger:"change"}],contestIds:[{required:!0,type:"array",min:1,message:"请至少选择一个赛事",trigger:"change"}],studentIds:[{required:!0,type:"array",min:1,message:"请至少选择一个学生",trigger:"change"}]},K=s=>({SCHEDULED:"未开始",ONGOING:"进行中",ENDED:"已结束"})[s||""]||"未知",j=s=>({SCHEDULED:"info",ONGOING:"success",ENDED:"warning"})[s||""]||"info",P=s=>s?s.replace("T"," ").substring(0,16):"-",b=async()=>{h.value=!0;try{const s={page:r.page,pageSize:r.pageSize,keyword:c.keyword||void 0,status:c.status||void 0},f=(await we(s)).data||{};U.value=f.plans||f.list||[],r.total=Number(f.total)||0,r.page=Number(f.page)||s.page||1,r.pageSize=Number(f.pageSize)||s.pageSize||10}catch(s){console.error("获取训练计划列表失败:",s),v.error(s?.message||"获取训练计划列表失败")}finally{h.value=!1}},C=()=>{r.page=1,b()},W=()=>{c.keyword="",c.status="",C()},J=s=>{r.page=s,b()},Q=s=>{r.pageSize=s,r.page=1,b()},X=s=>{O.push({name:"TrainingPlanDetail",params:{id:s}})},R=async s=>{a.isEdit=!!s,a.title=s?"编辑训练计划":"新建训练计划",s&&(a.form.planId=s.planId,a.form.title=s.title,a.form.description=s.description||"",a.form.startTime=s.startTime,a.form.endTime=s.endTime,a.form.contestIds=s.contests?.map(e=>e.contestId)||[],a.form.studentIds=s.students?.map(e=>e.userId)||[]),await Z(),a.visible=!0},Z=async()=>{try{const e=(await he({page:1,pageSize:100})).data;L.value=e?.contests||e?.list||[];const i=(await fe({page:1,pageSize:500,role:"STUDENT"})).data;H.value=i?.users||i?.list||[]}catch(s){console.error("加载数据失败:",s)}},ee=async()=>{T.value&&await T.value.validate(async s=>{if(s){a.submitting=!0;try{const e={title:a.form.title,description:a.form.description,startTime:a.form.startTime,endTime:a.form.endTime,contestIds:a.form.contestIds,studentIds:a.form.studentIds};a.isEdit&&a.form.planId?(e.planId=a.form.planId,await Te(e),v.success("训练计划更新成功")):(await Ce(e),v.success("训练计划创建成功")),a.visible=!1,b()}catch(e){console.error("保存训练计划失败:",e),v.error(e?.message||"保存训练计划失败")}finally{a.submitting=!1}}})},te=async s=>{try{await Ve(s),v.success("训练计划删除成功"),b()}catch(e){console.error("删除训练计划失败:",e),v.error(e?.message||"删除训练计划失败")}},ae=()=>{a.form={planId:void 0,title:"",description:"",startTime:"",endTime:"",contestIds:[],studentIds:[]},T.value?.clearValidate()};return ce(()=>{b()}),(s,e)=>{const f=n("el-icon"),i=n("el-button"),k=n("el-input"),u=n("el-form-item"),I=n("el-option"),E=n("el-select"),M=n("el-form"),g=n("el-table-column"),le=n("el-tag"),se=n("el-popconfirm"),oe=n("el-space"),ne=n("el-table"),re=n("el-pagination"),ie=n("el-card"),Y=n("el-date-picker"),de=n("el-dialog"),ue=ye("loading");return p(),V("div",ke,[d("div",Ee,[d("div",null,[d("h2",Se,_(y.value?"训练计划管理":"训练计划列表"),1),d("p",xe,_(y.value?"管理和查看训练计划":"浏览我的训练计划"),1)]),y.value?(p(),V("div",ze,[t(i,{type:"primary",onClick:e[0]||(e[0]=l=>R())},{default:o(()=>[t(f,null,{default:o(()=>[t(ge(_e))]),_:1}),e[11]||(e[11]=m(" 新建计划 ",-1))]),_:1})])):z("",!0)]),t(ie,{class:"page-card"},{default:o(()=>[t(M,{inline:!0,class:"filter-form"},{default:o(()=>[t(u,{label:"关键字"},{default:o(()=>[t(k,{modelValue:c.keyword,"onUpdate:modelValue":e[1]||(e[1]=l=>c.keyword=l),placeholder:"计划标题",clearable:"",onKeyup:ve(C,["enter"]),style:{width:"200px"}},null,8,["modelValue"])]),_:1}),t(u,{label:"状态"},{default:o(()=>[t(E,{modelValue:c.status,"onUpdate:modelValue":e[2]||(e[2]=l=>c.status=l),placeholder:"全部",clearable:"",onChange:C,style:{width:"120px"}},{default:o(()=>[t(I,{label:"未开始",value:"SCHEDULED"}),t(I,{label:"进行中",value:"ONGOING"}),t(I,{label:"已结束",value:"ENDED"})]),_:1},8,["modelValue"])]),_:1}),t(u,null,{default:o(()=>[t(i,{type:"primary",onClick:C},{default:o(()=>[...e[12]||(e[12]=[m("查询",-1)])]),_:1}),t(i,{onClick:W},{default:o(()=>[...e[13]||(e[13]=[m("重置",-1)])]),_:1})]),_:1})]),_:1}),be((p(),w(ne,{data:U.value,border:"",class:"plan-table"},{default:o(()=>[t(g,{prop:"planId",label:"ID",width:"80",align:"center"}),t(g,{prop:"title",label:"计划名称","min-width":"200"},{default:o(({row:l})=>[d("div",Ne,[d("span",Ue,_(l.title),1)])]),_:1}),t(g,{label:"时间范围",width:"180"},{default:o(({row:l})=>[d("div",Le,[d("div",null,_(P(l.startTime)),1),d("div",null,_(P(l.endTime)),1)])]),_:1}),t(g,{label:"状态",width:"100",align:"center"},{default:o(({row:l})=>[t(le,{type:j(l.status)},{default:o(()=>[m(_(K(l.status)),1)]),_:2},1032,["type"])]),_:1}),t(g,{prop:"contestCount",label:"赛事数",width:"100",align:"center"}),t(g,{prop:"studentCount",label:"学生数",width:"100",align:"center"}),t(g,{label:"操作",width:"200",fixed:"right"},{default:o(({row:l})=>[t(oe,{wrap:""},{default:o(()=>[t(i,{size:"small",text:"",type:"primary",onClick:$=>X(l.planId)},{default:o(()=>[...e[14]||(e[14]=[m("查看",-1)])]),_:1},8,["onClick"]),y.value&&l.status==="SCHEDULED"?(p(),w(i,{key:0,size:"small",text:"",type:"warning",onClick:$=>R(l)},{default:o(()=>[...e[15]||(e[15]=[m(" 编辑 ",-1)])]),_:1},8,["onClick"])):z("",!0),y.value&&l.status==="SCHEDULED"?(p(),w(se,{key:1,title:"确定删除该训练计划？","confirm-button-text":"删除","cancel-button-text":"取消","confirm-button-type":"danger",onConfirm:$=>te(l.planId)},{reference:o(()=>[t(i,{size:"small",text:"",type:"danger"},{default:o(()=>[...e[16]||(e[16]=[m("删除",-1)])]),_:1})]),_:1},8,["onConfirm"])):z("",!0)]),_:2},1024)]),_:1})]),_:1},8,["data"])),[[ue,h.value]]),d("div",He,[t(re,{background:"",layout:"total, sizes, prev, pager, next, jumper","current-page":r.page,"page-size":r.pageSize,total:r.total,"page-sizes":[10,20,30,50],onSizeChange:Q,onCurrentChange:J},null,8,["current-page","page-size","total"])])]),_:1}),t(de,{modelValue:a.visible,"onUpdate:modelValue":e[10]||(e[10]=l=>a.visible=l),title:a.title,width:"600px","destroy-on-close":"",onClosed:ae},{footer:o(()=>[t(i,{onClick:e[9]||(e[9]=l=>a.visible=!1)},{default:o(()=>[...e[17]||(e[17]=[m("取消",-1)])]),_:1}),t(i,{type:"primary",onClick:ee,loading:a.submitting},{default:o(()=>[m(_(a.isEdit?"保存":"创建"),1)]),_:1},8,["loading"])]),default:o(()=>[t(M,{model:a.form,"label-width":"100px",rules:B,ref_key:"planFormRef",ref:T},{default:o(()=>[t(u,{label:"计划名称",prop:"title"},{default:o(()=>[t(k,{modelValue:a.form.title,"onUpdate:modelValue":e[3]||(e[3]=l=>a.form.title=l),maxlength:"100","show-word-limit":""},null,8,["modelValue"])]),_:1}),t(u,{label:"计划说明",prop:"description"},{default:o(()=>[t(k,{modelValue:a.form.description,"onUpdate:modelValue":e[4]||(e[4]=l=>a.form.description=l),type:"textarea",rows:3,maxlength:"500","show-word-limit":""},null,8,["modelValue"])]),_:1}),t(u,{label:"开始时间",prop:"startTime"},{default:o(()=>[t(Y,{modelValue:a.form.startTime,"onUpdate:modelValue":e[5]||(e[5]=l=>a.form.startTime=l),type:"datetime",placeholder:"选择开始时间","value-format":"YYYY-MM-DD HH:mm:ss",style:{width:"100%"}},null,8,["modelValue"])]),_:1}),t(u,{label:"结束时间",prop:"endTime"},{default:o(()=>[t(Y,{modelValue:a.form.endTime,"onUpdate:modelValue":e[6]||(e[6]=l=>a.form.endTime=l),type:"datetime",placeholder:"选择结束时间","value-format":"YYYY-MM-DD HH:mm:ss",style:{width:"100%"}},null,8,["modelValue"])]),_:1}),t(u,{label:"选择赛事",prop:"contestIds"},{default:o(()=>[t(E,{modelValue:a.form.contestIds,"onUpdate:modelValue":e[7]||(e[7]=l=>a.form.contestIds=l),multiple:"",filterable:"",placeholder:"请选择赛事",style:{width:"100%"}},{default:o(()=>[(p(!0),V(q,null,G(L.value,l=>(p(),w(I,{key:l.contestId,label:l.title,value:l.contestId},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),t(u,{label:"选择学生",prop:"studentIds"},{default:o(()=>[t(E,{modelValue:a.form.studentIds,"onUpdate:modelValue":e[8]||(e[8]=l=>a.form.studentIds=l),multiple:"",filterable:"",placeholder:"请选择学生",style:{width:"100%"}},{default:o(()=>[(p(!0),V(q,null,G(H.value,l=>(p(),w(I,{key:l.userId,label:`${l.nickname} (${l.studentId})`,value:l.userId},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"])])}}}),qe=De(Pe,[["__scopeId","data-v-f3197bfa"]]);export{qe as default};
