import{d as xe,u as ke,r as M,s as U,k as D,p as Ue,c as K,a as f,b as l,t as v,l as C,q as V,w as a,e as p,E as g,v as Z,g as Se,f as Ee,i as c,x as Q,y as he,z as ze,o as y,_ as Be}from"./index-jbbSaPHq.js";import{g as Le,a as W,c as Pe,u as Ge,d as Oe,j as Ae}from"./contest-Cg3IoMP6.js";const Me={class:"contest-list-page page-shell"},Re={class:"page-header"},je={class:"page-header__title"},He={class:"page-header__subtitle"},qe={class:"header-actions"},Ye={class:"contest-name-cell"},$e={class:"contest-title"},Fe={class:"muted-text"},Je={class:"time-column"},Ke={class:"table-footer"},Ze={"element-loading-text":"加载中..."},Qe={class:"dialog-footer"},We=xe({__name:"list",setup(Xe){const R=Ee(),S=Se(),E=ke(),h=M([]),z=M(!1),d=U({keyword:"",visibility:"",status:"",state:"",sortBy:"id_asc"}),b=U({page:1,pageSize:10,total:0}),X=D(()=>E.role==="ADMIN"),ee=D(()=>E.role==="TEACHER"),te=D(()=>E.role==="STUDENT"),_=D(()=>X.value||ee.value),B=D(()=>te.value),le={background:"rgba(13, 17, 23, 0.65)",color:"#cdd9e5"},I=async()=>{z.value=!0;try{const t={page:b.page,pageSize:b.pageSize,keyword:d.keyword||void 0,visibility:d.visibility||void 0,status:d.status||void 0,state:d.state||void 0,sortBy:d.sortBy||"id_asc"},i=(await Le(t)).data||{},n=i.contests||i.list||[],r=Array.isArray(n)?n:[];h.value=r.map(H),b.total=Number(i.total)||0,b.page=Number(i.page)||t.page||1,b.pageSize=Number(i.pageSize)||t.pageSize||10,_e()}catch(t){console.error("获取赛事列表错误:",t),g.error(t?.message||"获取赛事列表失败")}finally{z.value=!1}},N=()=>{b.page=1,I()},ae=()=>{d.keyword="",d.visibility="",d.status="",d.state="",d.sortBy="id_asc",N()},se=t=>{b.page=t,I()},oe=t=>{b.pageSize=t,b.page=1,I()},ie=t=>t==="PUBLIC"?"公开":t==="PRIVATE"?"私有":"未知",ne=t=>({SCHEDULED:"未开始",ONGOING:"进行中",ENDED:"已结束"})[t||""]||"未知",re=t=>({SCHEDULED:"info",ONGOING:"success",ENDED:"warning"})[t||""]||"info",j=t=>t?t.replace("T"," "):"-",de=t=>{R.push({name:"ContestDetail",params:{id:t}})},L=()=>({contestId:void 0,title:"",description:"",startTime:"",endTime:"",password:"",visibility:"PUBLIC",problemIds:[]}),s=U({visible:!1,title:"新建赛事",form:L(),problemIdsText:"",submitting:!1,loading:!1}),T=M(),ue={title:[{required:!0,message:"请输入赛事名称",trigger:"blur"}],startTime:[{required:!0,message:"请选择开始时间",trigger:"change"}],endTime:[{required:!0,message:"请选择结束时间",trigger:"change"}],visibility:[{required:!0,message:"请选择可见性",trigger:"change"}]},P=async t=>{if(_.value){if(s.visible=!0,s.submitting=!1,s.loading=!1,t){s.title="编辑赛事",s.loading=!0;try{const i=(await W(t.contestId)).data||{};s.form={contestId:i.contestId||i.contest_id||t.contestId,title:i.title||t.title,description:i.description||"",startTime:x(i.startTime||i.start_time||t.startTime),endTime:x(i.endTime||i.end_time||t.endTime),password:i.password||t.password||"",visibility:i.visibility||"PUBLIC",problemIds:Array.isArray(i.problems)?i.problems.map(n=>Number(n.problemId||n.problem_id)).filter(n=>!Number.isNaN(n)):t.problemIds||[]},s.problemIdsText=s.form.problemIds.join(",")}catch(e){g.error(e?.message||"加载赛事详情失败"),s.visible=!1;return}finally{s.loading=!1}}else s.title="新建赛事",s.form=L(),s.problemIdsText="",await Z();me()}},me=async()=>{await Z(),T.value?.clearValidate?.()},pe=t=>t?t.split(",").map(e=>Number(e.trim())).filter(e=>!Number.isNaN(e)):[],H=t=>{const e=typeof t.visibility=="string"?t.visibility.toUpperCase():"",i=ce(t),n=Number(t.contestId||t.contest_id);return{contestId:Number.isNaN(n)?0:n,title:String(t.title||""),description:typeof t.description=="string"?t.description:"",startTime:x(String(t.startTime||t.start_time||"")),endTime:x(String(t.endTime||t.end_time||"")),visibility:e,status:i,participantCount:(t.participantCount||t.participant_count)!==void 0&&(t.participantCount||t.participant_count)!==null?Number(t.participantCount||t.participant_count):void 0}},ce=t=>{if(typeof t.status=="string"&&t.status.trim())return t.status.toUpperCase();const e=Date.now(),i=Date.parse(String(t.startTime||t.start_time||"")),n=Date.parse(String(t.endTime||t.end_time||""));return!Number.isNaN(i)&&e<i?"UPCOMING":!Number.isNaN(n)&&e>n?"FINISHED":"ONGOING"},fe=()=>{T.value&&T.value.validate(async t=>{if(t){s.submitting=!0;try{const e={contestId:s.form.contestId,title:s.form.title,description:s.form.description,startTime:s.form.startTime,endTime:s.form.endTime,password:s.form.password||void 0,visibility:s.form.visibility,problemIds:pe(s.problemIdsText)};if(!e.problemIds.length){g.warning("请至少填写一个题目 ID"),s.submitting=!1;return}const i=Date.parse(e.startTime.replace(" ","T")),n=Date.parse(e.endTime.replace(" ","T"));if(!Number.isNaN(i)&&!Number.isNaN(n)&&n<=i){g.warning("结束时间必须晚于开始时间"),s.submitting=!1;return}e.contestId?(await Ge(e),g.success("赛事更新成功")):(await Pe(e),g.success("赛事创建成功")),s.visible=!1,I()}catch(e){g.error(e?.message||"操作失败")}finally{s.submitting=!1}}})},be=async t=>{try{await Oe(t),g.success("赛事删除成功"),I()}catch(e){g.error(e?.message||"删除失败")}},u=U({visible:!1,contest:null,form:{password:"",teamName:""},submitting:!1}),G=t=>{u.visible=!0,u.contest=t,u.form.password="",u.form.teamName=""},ge=async()=>{if(u.contest){u.submitting=!0;try{await Ae({contestId:u.contest.contestId,password:u.form.password||void 0,teamName:u.form.teamName||void 0}),g.success("参赛成功"),u.visible=!1,I()}catch(t){g.error(t?.message||"参赛失败")}finally{u.submitting=!1}}},ve=t=>{if(!B.value)return!1;const e=(t.status||"").toUpperCase();return e==="UPCOMING"||e==="ONGOING"},x=t=>t?t.replace("T"," ").trim():"",ye=()=>{s.form=L(),s.problemIdsText="",s.submitting=!1,s.loading=!1,T.value?.clearValidate?.()},_e=()=>{const t=[],e=Number(S.query.edit);!Number.isNaN(e)&&e>0&&_.value&&(P({contestId:e,title:"",visibility:"PUBLIC",status:"",startTime:"",endTime:""}),t.push("edit"));const i=Number(S.query.join);if(!Number.isNaN(i)&&i>0&&B.value){const n=h.value.find(r=>r.contestId===i);n?(G(n),t.push("join")):(Ie(i).then(r=>{r&&G(r)}),t.push("join"))}if(t.length){const n={};Object.entries(S.query).forEach(([r,m])=>{t.includes(r)||(n[r]=m)}),R.replace({query:n})}},Ie=async t=>{try{const i=(await W(t)).data||{};return H(i)}catch(e){return g.warning(e?.message||"无法获取该赛事信息"),null}};return Ue(I),(t,e)=>{const i=p("el-button"),n=p("el-input"),r=p("el-form-item"),m=p("el-option"),k=p("el-select"),O=p("el-form"),w=p("el-table-column"),q=p("el-tag"),Ne=p("el-popconfirm"),Ce=p("el-space"),Ve=p("el-table"),Te=p("el-pagination"),we=p("el-card"),Y=p("el-date-picker"),$=p("el-radio"),De=p("el-radio-group"),F=p("el-dialog"),J=ze("loading");return y(),K("div",Me,[f("div",Re,[f("div",null,[f("h2",je,v(_.value?"赛事管理":"赛事列表"),1),f("p",He,v(_.value?"管理赛事，创建和编辑赛事，为用户准备赛事资源":"浏览赛事，查看赛事详情和参与"),1)]),f("div",qe,[_.value?(y(),C(i,{key:0,type:"primary",onClick:e[0]||(e[0]=o=>P())},{default:a(()=>[...e[19]||(e[19]=[c("新建赛事",-1)])]),_:1})):V("",!0),l(i,{type:"info",plain:"",onClick:I},{default:a(()=>[...e[20]||(e[20]=[c("刷新列表",-1)])]),_:1})])]),l(we,{class:"page-card"},{default:a(()=>[l(O,{inline:!0,model:d,"label-suffix":":",class:"filter-form"},{default:a(()=>[l(r,{label:"关键字"},{default:a(()=>[l(n,{modelValue:d.keyword,"onUpdate:modelValue":e[1]||(e[1]=o=>d.keyword=o),placeholder:"按名称搜索",clearable:"",onKeyup:he(N,["enter"]),style:{width:"200px"}},null,8,["modelValue"])]),_:1}),l(r,{label:"可见性"},{default:a(()=>[l(k,{modelValue:d.visibility,"onUpdate:modelValue":e[2]||(e[2]=o=>d.visibility=o),placeholder:"全部",clearable:"",onChange:N,style:{width:"120px"}},{default:a(()=>[l(m,{label:"公开",value:"PUBLIC"}),l(m,{label:"私有",value:"PRIVATE"})]),_:1},8,["modelValue"])]),_:1}),l(r,{label:"状态"},{default:a(()=>[l(k,{modelValue:d.status,"onUpdate:modelValue":e[3]||(e[3]=o=>d.status=o),placeholder:"全部",clearable:"",onChange:N,style:{width:"120px"}},{default:a(()=>[l(m,{label:"未开始",value:"SCHEDULED"}),l(m,{label:"进行中",value:"ONGOING"}),l(m,{label:"已结束",value:"ENDED"})]),_:1},8,["modelValue"])]),_:1}),_.value?(y(),C(r,{key:0,label:"显示状态"},{default:a(()=>[l(k,{modelValue:d.state,"onUpdate:modelValue":e[4]||(e[4]=o=>d.state=o),placeholder:"全部",clearable:"",onChange:N,style:{width:"120px"}},{default:a(()=>[l(m,{label:"使用中",value:"USING"}),l(m,{label:"已隐藏",value:"HIDDEN"})]),_:1},8,["modelValue"])]),_:1})):V("",!0),l(r,{label:"排序"},{default:a(()=>[l(k,{modelValue:d.sortBy,"onUpdate:modelValue":e[5]||(e[5]=o=>d.sortBy=o),placeholder:"默认排序",onChange:N,style:{width:"140px"}},{default:a(()=>[l(m,{label:"ID升序",value:"id_asc"}),l(m,{label:"ID降序",value:"id_desc"}),l(m,{label:"开始时间升序",value:"start_asc"}),l(m,{label:"开始时间降序",value:"start_desc"}),l(m,{label:"结束时间升序",value:"end_asc"}),l(m,{label:"结束时间降序",value:"end_desc"}),l(m,{label:"标题A-Z",value:"title_asc"}),l(m,{label:"标题Z-A",value:"title_desc"})]),_:1},8,["modelValue"])]),_:1}),l(r,null,{default:a(()=>[l(i,{type:"primary",onClick:N},{default:a(()=>[...e[21]||(e[21]=[c("查询",-1)])]),_:1}),l(i,{onClick:ae},{default:a(()=>[...e[22]||(e[22]=[c("重置",-1)])]),_:1})]),_:1})]),_:1},8,["model"]),Q((y(),C(Ve,{data:h.value,border:"","header-cell-style":le,class:"contest-table"},{default:a(()=>[l(w,{prop:"contestId",label:"ID",width:"80",align:"center"}),l(w,{prop:"title",label:"赛事名称","min-width":"200"},{default:a(({row:o})=>[f("div",Ye,[f("span",$e,v(o.title||"-"),1),o.visibility?(y(),C(q,{key:0,size:"small",type:"info",effect:"plain"},{default:a(()=>[c(v(ie(o.visibility)),1)]),_:2},1024)):V("",!0)]),f("p",Fe,v(o.description||"暂无描述"),1)]),_:1}),l(w,{label:"时间","min-width":"220"},{default:a(({row:o})=>[f("div",Je,[f("span",null,"开始："+v(j(o.startTime)),1),f("span",null,"结束："+v(j(o.endTime)),1)])]),_:1}),l(w,{prop:"status",label:"状态",width:"120",align:"center"},{default:a(({row:o})=>[l(q,{type:re(o.status)},{default:a(()=>[c(v(ne(o.status)),1)]),_:2},1032,["type"])]),_:1}),l(w,{label:"操作","min-width":"220",fixed:"right"},{default:a(({row:o})=>[l(Ce,{wrap:""},{default:a(()=>[l(i,{size:"small",text:"",type:"primary",onClick:A=>de(o.contestId)},{default:a(()=>[...e[23]||(e[23]=[c("查看详情",-1)])]),_:1},8,["onClick"]),B.value&&ve(o)?(y(),C(i,{key:0,size:"small",text:"",type:"success",onClick:A=>G(o)},{default:a(()=>[...e[24]||(e[24]=[c(" 参与赛事 ",-1)])]),_:1},8,["onClick"])):V("",!0),_.value?(y(),C(i,{key:1,size:"small",text:"",type:"warning",onClick:A=>P(o)},{default:a(()=>[...e[25]||(e[25]=[c(" 编辑 ",-1)])]),_:1},8,["onClick"])):V("",!0),_.value?(y(),C(Ne,{key:2,title:"确定删除该赛事？","confirm-button-text":"删除","cancel-button-text":"取消","confirm-button-type":"danger",onConfirm:A=>be(o.contestId)},{reference:a(()=>[l(i,{size:"small",text:"",type:"danger"},{default:a(()=>[...e[26]||(e[26]=[c("删除",-1)])]),_:1})]),_:1},8,["onConfirm"])):V("",!0)]),_:2},1024)]),_:1})]),_:1},8,["data"])),[[J,z.value]]),f("div",Ke,[l(Te,{background:"",layout:"total, sizes, prev, pager, next, jumper","current-page":b.page,"page-size":b.pageSize,total:b.total,"page-sizes":[10,20,30,50],onSizeChange:oe,onCurrentChange:se},null,8,["current-page","page-size","total"])])]),_:1}),l(F,{modelValue:s.visible,"onUpdate:modelValue":e[14]||(e[14]=o=>s.visible=o),title:s.title,width:"520px","destroy-on-close":"",onClosed:ye},{footer:a(()=>[f("span",Qe,[l(i,{onClick:e[13]||(e[13]=o=>s.visible=!1)},{default:a(()=>[...e[29]||(e[29]=[c("取消",-1)])]),_:1}),l(i,{type:"primary",loading:s.submitting,onClick:fe},{default:a(()=>[...e[30]||(e[30]=[c("保存",-1)])]),_:1},8,["loading"])])]),default:a(()=>[Q((y(),K("div",Ze,[l(O,{model:s.form,"label-width":"96px",rules:ue,ref_key:"contestFormRef",ref:T},{default:a(()=>[l(r,{label:"赛事名称",prop:"title"},{default:a(()=>[l(n,{modelValue:s.form.title,"onUpdate:modelValue":e[6]||(e[6]=o=>s.form.title=o),maxlength:"80","show-word-limit":""},null,8,["modelValue"])]),_:1}),l(r,{label:"赛事介绍",prop:"description"},{default:a(()=>[l(n,{modelValue:s.form.description,"onUpdate:modelValue":e[7]||(e[7]=o=>s.form.description=o),type:"textarea",rows:3,maxlength:"300","show-word-limit":""},null,8,["modelValue"])]),_:1}),l(r,{label:"开始时间",prop:"startTime"},{default:a(()=>[l(Y,{modelValue:s.form.startTime,"onUpdate:modelValue":e[8]||(e[8]=o=>s.form.startTime=o),type:"datetime","value-format":"YYYY-MM-DD HH:mm:ss",placeholder:"选择开始时间",style:{width:"100%"}},null,8,["modelValue"])]),_:1}),l(r,{label:"结束时间",prop:"endTime"},{default:a(()=>[l(Y,{modelValue:s.form.endTime,"onUpdate:modelValue":e[9]||(e[9]=o=>s.form.endTime=o),type:"datetime","value-format":"YYYY-MM-DD HH:mm:ss",placeholder:"选择结束时间",style:{width:"100%"}},null,8,["modelValue"])]),_:1}),l(r,{label:"可见性",prop:"visibility"},{default:a(()=>[l(De,{modelValue:s.form.visibility,"onUpdate:modelValue":e[10]||(e[10]=o=>s.form.visibility=o)},{default:a(()=>[l($,{label:"PUBLIC"},{default:a(()=>[...e[27]||(e[27]=[c("公开",-1)])]),_:1}),l($,{label:"PRIVATE"},{default:a(()=>[...e[28]||(e[28]=[c("私有",-1)])]),_:1})]),_:1},8,["modelValue"])]),_:1}),l(r,{label:"参赛密码"},{default:a(()=>[l(n,{modelValue:s.form.password,"onUpdate:modelValue":e[11]||(e[11]=o=>s.form.password=o),placeholder:"可选"},null,8,["modelValue"])]),_:1}),l(r,{label:"题目 ID"},{default:a(()=>[l(n,{modelValue:s.problemIdsText,"onUpdate:modelValue":e[12]||(e[12]=o=>s.problemIdsText=o),placeholder:"输入题目ID，使用逗号分隔"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])])),[[J,s.loading]])]),_:1},8,["modelValue","title"]),l(F,{modelValue:u.visible,"onUpdate:modelValue":e[18]||(e[18]=o=>u.visible=o),title:"参赛确认",width:"420px","destroy-on-close":""},{footer:a(()=>[l(i,{onClick:e[17]||(e[17]=o=>u.visible=!1)},{default:a(()=>[...e[31]||(e[31]=[c("取消",-1)])]),_:1}),l(i,{type:"primary",loading:u.submitting,onClick:ge},{default:a(()=>[...e[32]||(e[32]=[c("确认参赛",-1)])]),_:1},8,["loading"])]),default:a(()=>[l(O,{model:u.form,"label-width":"88px"},{default:a(()=>[l(r,{label:"赛事名称"},{default:a(()=>[f("span",null,v(u.contest?.title||"-"),1)]),_:1}),l(r,{label:"赛事密码"},{default:a(()=>[l(n,{modelValue:u.form.password,"onUpdate:modelValue":e[15]||(e[15]=o=>u.form.password=o),placeholder:"如有密码请填写"},null,8,["modelValue"])]),_:1}),l(r,{label:"队伍名称"},{default:a(()=>[l(n,{modelValue:u.form.teamName,"onUpdate:modelValue":e[16]||(e[16]=o=>u.form.teamName=o),placeholder:"可选"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])])}}}),lt=Be(We,[["__scopeId","data-v-904530a0"]]);export{lt as default};
